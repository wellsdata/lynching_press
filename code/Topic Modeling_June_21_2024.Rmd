---
title: "Mainstream Papers Topic Modeling"
author: "(redated - peer review)"
date: '2024-6-21'
output: html_document
---
#---------------------------------------------
# Mainstream Papers Topic Modeling
#---------------------------------------------
This notebook will import 11,223 text files and related metadata files and execute basic topic modeling with LADAL Method
I've adapted this LADAL tutorial for the lynching research: https://ladal.edu.au/topicmodels.html

Load up the packages if you haven't already....

```{r}
# install.packages("here")
# install.packages("tidytext")
# install.packages("quanteda")
# # install packages
# install.packages("tm")
# install.packages("topicmodels")
# install.packages("reshape2")
# #install.packages("ggplot2")
# install.packages("wordcloud")
# install.packages("pals")
# install.packages("SnowballC")
# install.packages("lda")
# install.packages("ldatuning")
# install.packages("kableExtra")
# install.packages("DT")
# install.packages("flextable")
# # install klippy for copy-to-clipboard button in code chunks
# install.packages("remotes")
# remotes::install_github("rlesur/klippy")

```


```{r include=FALSE}
# set options
options(stringsAsFactors = F)         # no automatic data transformation
options("scipen" = 100, "digits" = 4) # suppress math annotation
# load packages
here::here()
library(tidyverse)
library(tidytext)
library(rio)
library(readtext)
#topic modeling
library(quanteda)
library(tm)
library(topicmodels)
library(lda)
library(ldatuning)
# from tutorial packages
library(DT)
library(knitr) 
library(kableExtra) 
library(reshape2)
library(ggplot2)
library(wordcloud)
library(pals)
library(SnowballC)
library(flextable)

# activate klippy for copy-to-clipboard button
klippy::klippy()
```


### Import Data
```{r include=FALSE}
#import 11,223 text files that were compiled into a df  
lynch <- read_csv("https://osf.io/download/p32he/?view_only=6c106acd6cb54f6f849e8c6f9098809f")

#index of 11,223 extracted articles, a 19% sample which has been checked by a coder and represents all valid entries
master_article_index_june_22_2024 <- read_csv("https://osf.io/download/hzyw6/?view_only=6c106acd6cb54f6f849e8c6f9098809f") %>%
  as.data.frame()


#60,042 Library of Congress articles on lynching captured.
main_index <- read_csv("https://osf.io/download/hda4v/?view_only=6c106acd6cb54f6f849e8c6f9098809f")

main_index <- janitor::clean_names(main_index)

#subset 9589 mainstream white owned paper articles to eliminate Black newspapers
lynch1 <- lynch %>% 
    filter(black_press != "Y" | is.na(black_press))

#subset the 1634 Black press news articles
black_articles <- lynch %>% 
    filter(black_press == "Y")

#strip down to filename and text for tokenizing
textdata <- lynch %>% 
  select(filename, sentence, year) %>% 
  as.data.frame() %>% 
  rename(doc_id = filename, text= sentence)

```

# Topic Modeling Predmoninantly White-Owned Papers


### Process into corpus object
```{r}
textdata <- lynch1 %>% 
  select(filename, sentence, year) %>% 
  as.data.frame() %>% 
  rename(doc_id = filename, text= sentence)

# load stopwords
english_stopwords <- readLines("https://slcladal.github.io/resources/stopwords_en.txt", encoding = "UTF-8")
# create corpus object
corpus <- Corpus(DataframeSource(textdata))
# Preprocessing chain
processedCorpus <- tm_map(corpus, content_transformer(tolower))
processedCorpus <- tm_map(processedCorpus, removeWords, english_stopwords)
processedCorpus <- tm_map(processedCorpus, removePunctuation, preserve_intra_word_dashes = TRUE)
processedCorpus <- tm_map(processedCorpus, removeNumbers)
processedCorpus <- tm_map(processedCorpus, stemDocument, language = "en")
processedCorpus <- tm_map(processedCorpus, stripWhitespace)
```

```{r tm3a}
#DTM: rows correspond to the documents in the corpus. Columns correspond to the terms in the documents. Cells correspond to the weights of the terms. (Girder)
# compute document term matrix with terms >= minimumFrequency
minimumFrequency <- 5
DTM <- DocumentTermMatrix(processedCorpus, control = list(bounds = list(global = c(minimumFrequency, Inf))))
# have a look at the number of documents and terms in the matrix
dim(DTM)
# due to vocabulary pruning, we have empty rows in our DTM
# LDA does not like this. So we remove those docs from the
# DTM and the metadata
sel_idx <- slam::row_sums(DTM) > 0
DTM <- DTM[sel_idx, ]
textdata <- textdata[sel_idx, ]
#5 term minimum[1] 1387 3019
#5 term minimum[1] 308597 10339

``` 


## Topic proportions over time{-}

We examine topics in the data over time by aggregating mean topic proportions per decade. These aggregated topic proportions can then be visualized, e.g. as a bar plot. 


```{r}
# append decade information for aggregation
textdata$decade <- paste0(substr(textdata$year, 0, 3), "0")
```

Articles per decade

```{r}
#install.packages("formattable")
articles_decades <- textdata %>% 
  distinct(doc_id, .keep_all=TRUE) %>% 
  count(decade) %>% 
  mutate(pct_total= (n/sum(n))) %>% 
  mutate(pct_total= formattable::percent(pct_total)) %>% 
  # mutate(pct_total = round(pct_total, 1)) %>% 
  arrange(desc(decade))

library(kableExtra)
articles_decades %>%
  kbl(caption = "LOC Lynching Articles by Decade (n=11,223, 6/23/2024)", font_size = 30) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>% 
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, width = "5em") %>% 
  column_spec(3, width = "5em", background = "yellow") 



#Fact check 308597 rows tabulated
#sum(articles_decades$n)
```


```{r tm12}
# number of topics
# K <- 20
K <- 6
# set random number generator seed
set.seed(9161)
#Latent Dirichlet Allocation, LDA
topicModel2 <- LDA(DTM, K, method="Gibbs", control=list(iter = 500, verbose = 25, alpha = 0.2))
tmResult <- posterior(topicModel2)
theta <- tmResult$topics
beta <- tmResult$terms
topicNames <- apply(terms(topicModel2, 10), 2, paste, collapse = " ")  # reset topicnames
```
### Mean topic proportions per decade

```{r}
# Step 1: Check dimensions
n_theta <- nrow(theta)
n_textdata <- length(textdata$decade)

cat("Number of rows in theta: ", n_theta, "\n")
cat("Number of documents in textdata: ", n_textdata, "\n")

# Check if textdata contains all the documents in theta
common_ids <- intersect(rownames(theta), textdata$doc_id) # Assuming textdata has a 'doc_id' column

# Filter textdata to include only the documents present in theta
textdata_filtered <- textdata[textdata$doc_id %in% common_ids, ]

# Check dimensions after filtering
n_textdata_filtered <- nrow(textdata_filtered)
cat("Number of documents in filtered textdata: ", n_textdata_filtered, "\n")

# Ensure the lengths match now
if (n_theta != n_textdata_filtered) {
  stop("The number of rows in 'theta' still does not match the length of 'textdata_filtered$decade'.")
}

# Align rownames of theta with filtered textdata
theta_aligned <- theta[rownames(theta) %in% textdata_filtered$doc_id, ]

# Optional: Verify the order of documents
if (!all(rownames(theta_aligned) == textdata_filtered$doc_id)) {
  # If the order doesn't match, reorder one to match the other
  textdata_filtered <- textdata_filtered[match(rownames(theta_aligned), textdata_filtered$doc_id), ]
}

# Ensure they are now aligned and can be combined
if (!all(rownames(theta_aligned) == textdata_filtered$doc_id)) {
  stop("The document IDs still do not match. Please check the data alignment.")
}

# Step 2: Combine data
topic_data <- data.frame(theta_aligned, decade = textdata_filtered$decade)

# Step 3: Aggregate data
topic_proportion_per_decade <- aggregate(. ~ decade, data = topic_data, FUN = mean)


# get mean topic proportions per decade
# topic_proportion_per_decade <- aggregate(theta, by = list(decade = textdata$decade), mean)
# set topic names to aggregated columns
colnames(topic_proportion_per_decade)[2:(K+1)] <- topicNames
# reshape data frame
vizDataFrame <- melt(topic_proportion_per_decade, id.vars = "decade")

# #filter out 1960 - one article
vizDataFrame <- vizDataFrame %>% 
   filter(!decade==1960)
```


```{r}

#add categories

vizDataFrame <- vizDataFrame %>% 
  mutate(category = case_when(
    str_detect(variable,  "counti citi night mile jail day town morn march juli") ~ "lynchings",
    str_detect(variable, "law crime peopl lynch great excit state good citizen countri") ~ "critizing_lynching",
    str_detect(variable, "lynch mob negro jail men hang night crowd prison attempt") ~ "negro_lynching",
    str_detect(variable, "negro murder white lynch man kill year assault charg mrs") ~ "female_victim",
     str_detect(variable, "sheriff state court juri governor order offic prison judg deputi") ~ "legal",
    str_detect(variable, "bodi fire shot hang hous tree found street rope door") ~ "lynch_mob",
    ))


```

# Fact Check and Validate Topics

Topic 1: lynchings "counti citi night mile jail day town morn march juli" 
Topic 2: criticizing_lynchings "law crime peopl lynch great excit state good citizen countri" 
Topic 3: negro_lynching "lynch mob negro jail men hang night crowd prison attempt" 
Topic 4: female_victim "negro murder white lynch man kill year assault charg mrs" 
Topic 5: 5_legal_proceedings "sheriff state court juri governor order offic prison judg deputi" 
Topic 6:  lynch_mob "bodi fire shot hang hous tree found street rope door" 


### for female_victim 
```{r}
theta2 <- as.data.frame(theta)

female <- theta2 %>% 
  #renaming for a general topic
  rename(female = '4') %>% 
  top_n(20, female ) %>%
  arrange(desc(female )) %>% 
  select(female )

# Apply rownames_to_column
female  <- tibble::rownames_to_column(female , "story_id") 

female $story_id <- gsub("X", "", female $story_id)

head(female$story_id, 20)
#Checks out June 23


```

     
### for 5_legal_proceedings
```{r}
theta2 <- as.data.frame(theta)

legal <- theta2 %>% 
  #renaming for a general topic
  rename(legal = '5') %>% 
  top_n(20, legal ) %>%
  arrange(desc(legal )) %>% 
  select(legal )

# Apply rownames_to_column
legal  <- tibble::rownames_to_column(legal , "story_id") 

legal $story_id <- gsub("X", "", legal $story_id)

head(legal$story_id, 20)
#Checks out June 23


```


### for negro_lynching
```{r}
theta2 <- as.data.frame(theta)

unknown <- theta2 %>% 
  #renaming for a general topic
  rename(unknown = '3') %>% 
  top_n(20, unknown ) %>%
  arrange(desc(unknown )) %>% 
  select(unknown )

# Apply rownames_to_column
unknown  <- tibble::rownames_to_column(unknown , "story_id") 

unknown $story_id <- gsub("X", "", unknown $story_id)

head(unknown$story_id, 20)
#Checks out June 23
#main theme is negros are lynching victims

```

#### for critizing_lynching
```{r}
theta2 <- as.data.frame(theta)

critic<- theta2 %>% 
  #renaming for a general topic
  rename(critic = '2') %>% 
  top_n(20, critic) %>%
  arrange(desc(critic)) %>% 
  select(critic)

# Apply rownames_to_column
critic <- tibble::rownames_to_column(critic, "story_id") 

critic$story_id <- gsub("X", "", critic$story_id)

#Checks out June 23


```



#Figure 15: mainstrean_topics_june23_2024

```{r}
# plot topic proportions per decade as bar plot
ggplot(vizDataFrame, aes(x=decade, y=value, fill=category)) + 
  geom_bar(stat = "identity") + ylab("proportion") + 
  scale_fill_manual(values = paste0(alphabet(20), "FF"), name = "decade") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
   scale_fill_manual(values=c("#9933FF",
                              "#33FFFF",
                              "red",
                              "yellow",
                              "darkblue",
                              "green"))+
   #                           "blue"))+ 
   #                           #"pink",
   #                           #"gray",
   #                           #"orange")) +
  labs(title = "Common Narratives in Lynching News Coverage",
       subtitle = "Six Probable Topics in 9,589 extracted articles",
       caption = "Aggregate mean topic proportions per decade. Graphic by (redated - peer review) & (redated - peer review), 6-23-2024")

ggsave(here::here("../lynching_press/output_images_tables/Article_Images/Figure_15_mainstrean_topics_june23_2024.png"),device = "png",width=9,height=6, dpi=800)
```

#---------------------------------------------
# Black Only Paper Topic Modeling
#---------------------------------------------

### Process into corpus object
```{r}
textdata <- black_articles %>% 
  select(filename, sentence, year) %>% 
  as.data.frame() %>% 
  rename(doc_id = filename, text= sentence)

# load stopwords
english_stopwords <- readLines("https://slcladal.github.io/resources/stopwords_en.txt", encoding = "UTF-8")
# create corpus object
corpus <- Corpus(DataframeSource(textdata))
# Preprocessing chain
processedCorpus <- tm_map(corpus, content_transformer(tolower))
processedCorpus <- tm_map(processedCorpus, removeWords, english_stopwords)
processedCorpus <- tm_map(processedCorpus, removePunctuation, preserve_intra_word_dashes = TRUE)
processedCorpus <- tm_map(processedCorpus, removeNumbers)
processedCorpus <- tm_map(processedCorpus, stemDocument, language = "en")
processedCorpus <- tm_map(processedCorpus, stripWhitespace)
```

```{r tm3a}
#DTM: rows correspond to the documents in the corpus. Columns correspond to the terms in the documents. Cells correspond to the weights of the terms. (Girder)
# compute document term matrix with terms >= minimumFrequency
minimumFrequency <- 5
DTM <- DocumentTermMatrix(processedCorpus, control = list(bounds = list(global = c(minimumFrequency, Inf))))
# have a look at the number of documents and terms in the matrix
dim(DTM)
# due to vocabulary pruning, we have empty rows in our DTM
# LDA does not like this. So we remove those docs from the
# DTM and the metadata
sel_idx <- slam::row_sums(DTM) > 0
DTM <- DTM[sel_idx, ]
textdata <- textdata[sel_idx, ]
#5 term minimum[1] 1387 3019
#5 term minimum[1] 308597 10339

``` 


## Topic proportions over time{-}

We examine topics in the data over time by aggregating mean topic proportions per decade. These aggregated topic proportions can then be visualized, e.g. as a bar plot. 


```{r}
# append decade information for aggregation
textdata$decade <- paste0(substr(textdata$year, 0, 3), "0")
```

Articles per decade

```{r}
#install.packages("formattable")
articles_decades <- textdata %>% 
  distinct(doc_id, .keep_all=TRUE) %>% 
  count(decade) %>% 
  mutate(pct_total= (n/sum(n))) %>% 
  mutate(pct_total= formattable::percent(pct_total)) %>% 
  # mutate(pct_total = round(pct_total, 1)) %>% 
  arrange(desc(decade))

library(kableExtra)
articles_decades %>%
  kbl(caption = "Black Press Lynching Articles by Decade (n=1,634, 6/24/2024)", font_size = 30) %>%
  kable_classic(full_width = F, html_font = "Cambria") %>% 
  column_spec(1, bold = T, border_right = T) %>%
  column_spec(2, width = "5em") %>% 
  column_spec(3, width = "5em", background = "yellow") 



#Fact check 308597 rows tabulated
#sum(articles_decades$n)
```


```{r tm12}
# number of topics
# K <- 20
K <- 6
# set random number generator seed
set.seed(9161)
#Latent Dirichlet Allocation, LDA
topicModel2 <- LDA(DTM, K, method="Gibbs", control=list(iter = 500, verbose = 25, alpha = 0.2))
tmResult <- posterior(topicModel2)
theta <- tmResult$topics
beta <- tmResult$terms
topicNames <- apply(terms(topicModel2, 10), 2, paste, collapse = " ")  # reset topicnames
```
### Mean topic proportions per decade

```{r}
# Step 1: Check dimensions
n_theta <- nrow(theta)
n_textdata <- length(textdata$decade)

cat("Number of rows in theta: ", n_theta, "\n")
cat("Number of documents in textdata: ", n_textdata, "\n")

# Check if textdata contains all the documents in theta
common_ids <- intersect(rownames(theta), textdata$doc_id) # Assuming textdata has a 'doc_id' column

# Filter textdata to include only the documents present in theta
textdata_filtered <- textdata[textdata$doc_id %in% common_ids, ]

# Check dimensions after filtering
n_textdata_filtered <- nrow(textdata_filtered)
cat("Number of documents in filtered textdata: ", n_textdata_filtered, "\n")

# Ensure the lengths match now
if (n_theta != n_textdata_filtered) {
  stop("The number of rows in 'theta' still does not match the length of 'textdata_filtered$decade'.")
}

# Align rownames of theta with filtered textdata
theta_aligned <- theta[rownames(theta) %in% textdata_filtered$doc_id, ]

# Optional: Verify the order of documents
if (!all(rownames(theta_aligned) == textdata_filtered$doc_id)) {
  # If the order doesn't match, reorder one to match the other
  textdata_filtered <- textdata_filtered[match(rownames(theta_aligned), textdata_filtered$doc_id), ]
}

# Ensure they are now aligned and can be combined
if (!all(rownames(theta_aligned) == textdata_filtered$doc_id)) {
  stop("The document IDs still do not match. Please check the data alignment.")
}

# Step 2: Combine data
topic_data <- data.frame(theta_aligned, decade = textdata_filtered$decade)

# Step 3: Aggregate data
topic_proportion_per_decade <- aggregate(. ~ decade, data = topic_data, FUN = mean)


# get mean topic proportions per decade
# topic_proportion_per_decade <- aggregate(theta, by = list(decade = textdata$decade), mean)
# set topic names to aggregated columns
colnames(topic_proportion_per_decade)[2:(K+1)] <- topicNames
# reshape data frame
vizDataFrame <- melt(topic_proportion_per_decade, id.vars = "decade")

# remove outliers, keep decades consistent with white press
vizDataFrame <- vizDataFrame %>% 
   filter(decade<1960)
```


```{r}

#add categories

vizDataFrame <- vizDataFrame %>% 
  mutate(category = case_when(
    str_detect(variable,  "state court law case juri offic unit investig made feder") ~ "investigate-prosecute",
    str_detect(variable, "white negro man color men south peopl lynch black woman") ~ "racism",
    str_detect(variable, "law race lynch bill negro nation civil right countri peopl") ~ "legislation",
    str_detect(variable, "lynch mob negro murder crime year charg victim violenc law") ~ "lynch_mob",
     str_detect(variable, "mrs governor continu york presid citi nation associ page church") ~ "misc_lynching",
    str_detect(variable, "jail sheriff counti mob bodi negro night shot found kill") ~ "misc_lynching",
    ))


```

# Fact Check Black Press and Validate Topics


Topic 1: investigate_prosecute: "state court law case juri offic unit investig made feder" 
Topic 2: racism: "white negro man color men south peopl lynch black woman" 
Topic 3: legislation: law race lynch bill negro nation civil right countri peopl" 
Topic 4: lynch_mob: "lynch mob negro murder crime year charg victim violenc law"
Topic 5: misc_lynching: "mrs governor continu york presid citi nation associ page church"
Topic 6: misc_lynching: "jail sheriff counti mob bodi negro night shot found kill"

### for unknown
```{r}
theta2 <- as.data.frame(theta)

unknown <- theta2 %>% 
  #renaming for a general topic
  rename(unknown = '6') %>% 
  top_n(20, unknown ) %>%
  arrange(desc(unknown )) %>% 
  select(unknown )

# Apply rownames_to_column
unknown  <- tibble::rownames_to_column(unknown , "story_id") 

unknown $story_id <- gsub("X", "", unknown $story_id)

head(unknown$story_id, 20)
#Checks out June 24


```


### for misc_lynching
```{r}
theta2 <- as.data.frame(theta)

civil <- theta2 %>% 
  #renaming for a general topic
  rename(civil = '5') %>% 
  top_n(20, civil ) %>%
  arrange(desc(civil )) %>% 
  select(civil )

# Apply rownames_to_column
civil  <- tibble::rownames_to_column(civil , "story_id") 

civil $story_id <- gsub("X", "", civil $story_id)

head(civil$story_id, 20)
#Checks out June 24


```

### for legislation
```{r}
theta2 <- as.data.frame(theta)

legal <- theta2 %>% 
  #renaming for a general topic
  rename(legal = '3') %>% 
  top_n(20, legal ) %>%
  arrange(desc(legal )) %>% 
  select(legal )

# Apply rownames_to_column
legal  <- tibble::rownames_to_column(legal , "story_id") 

legal $story_id <- gsub("X", "", legal $story_id)

head(legal$story_id, 20)
#Checks out June 24


```

### for investigate_prosecute
```{r}
theta2 <- as.data.frame(theta)

investigate <- theta2 %>% 
  #renaming for a general topic
  rename(investigate = '1') %>% 
  top_n(20, investigate ) %>%
  arrange(desc(investigate )) %>% 
  select(investigate )

# Apply rownames_to_column
investigate  <- tibble::rownames_to_column(investigate , "story_id") 

investigate $story_id <- gsub("X", "", investigate $story_id)

head(investigate$story_id, 20)
#Checks out June 24


```
### for racism
```{r}
theta2 <- as.data.frame(theta)

race <- theta2 %>% 
  #renaming for a general topic
  rename(race = '2') %>% 
  top_n(20, race ) %>%
  arrange(desc(race )) %>% 
  select(race )

# Apply rownames_to_column
race  <- tibble::rownames_to_column(race , "story_id") 

race $story_id <- gsub("X", "", race $story_id)

head(race$story_id, 20)
#Checks out June 24


```

#Figure 14: Figure_14_black_press_topics_june24_2024

```{r}
# plot topic proportions per decade as bar plot
ggplot(vizDataFrame, aes(x=decade, y=value, fill=category)) + 
  geom_bar(stat = "identity") + ylab("proportion") + 
  scale_fill_manual(values = paste0(alphabet(20), "FF"), name = "decade") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
   scale_fill_manual(values=c("#9933FF",
                              "#33FFFF",
                              "red",
                              "yellow",
                              "darkblue",
                              "green"))+
   #                           "blue"))+ 
   #                           #"pink",
   #                           #"gray",
   #                           #"orange")) +
  labs(title = "Common Narratives in Black Press Lynching News Coverage",
       subtitle = "Six Probable Topics in 1,633 extracted articles",
       caption = "Aggregate mean topic proportions per decade. Graphic by (redated - peer review) & (redated - peer review), 6-24-2024")

ggsave(here::here("../lynching_press/output_images_tables/Article_Images/Figure_14_black_press_topics_june24_2024.png"),device = "png",width=9,height=6, dpi=800)
```

